<html>
    <head>
        <meta charset="utf-8">
        <link rel=stylesheet href="leaflet\leaflet.css" type=text/css>
        <script src=leaflet\leaflet.js></script>
        <script src=d3\d3.js></script>
        <style type="text/css">
            @font-face{
                font-family: "Droid Sans";
                src: url("./fonts/DroidSans-Regular.ttf");
            }

            *{

                font-family: 'Droid Sans';
            }
        
            body{
                margin: 0;
                overflow: hidden;
            }

            #mapid{
                height: 60%;
                width: 100%;
                float: left;
                transition: all 0.5s;
                z-index: -1;
                position: absolute;
            }

            #bottom-svg{
                width: 100%;
                height: 100%;
                position: absolute;
                bottom: 0;
            }

            #bottom-panel-wrapper{
                transition: all 0.5s;
                width: 100%;
                height: 40%;
                background-color: #ddd;
                position: absolute;
                bottom: 0;
                z-index: -1;
            }

            #target-list-id{
                height: 100%;
                width: 0px;
                float: right;
                overflow: auto;
                background-color: #333;
                color: #ddd;
                text-align: center;
                transition: all 0.5s;
                position: relative;
            }

            #target-list-table{
                border-collapse: collapse;
                color: #ddd;
                width: 100%;
            }

            #target-list-table-first{
                text-align: left;
            }

            #target-list-table td{
                padding: 20px 10px;
                cursor: pointer;
            }

            #target-list-table tr:hover{
                background-color: rgba(0, 255, 255, 0.5);
            }

            #target-list-table-body tr{
                transition: .5s all;
            }

            #target-list-hr{
                width: 75%;
                margin: auto;
                margin-bottom: 45px;
            }

            .context-menu{
                list-style: none;
                width: 50%;
            }

            #toggle-button{
                height: 50px;
                width: 50px;
                background: url("sidebar-button-icon.png");
                position: absolute;
                z-index: 999;
                left: calc(100% - 50px);
                transition: all 0.5s;
                border-radius: 0 0 0 5px;
                cursor: pointer;
            }

            .active{
                background-color: cyan !important;
                color: #333;
            }

            div[id*=sample-space-]{
                width: 33%;
                height: 100%;
                float: left;
                margin: auto;
                overflow-y: auto;
                overflow-x: hidden;
            }

            div[id^=sample-space-] h1{
                margin-left: 12px;
            }

            .panel-1-list{
                width: 100%;
                margin-left: 0;
                list-style: none;
                padding: 5px 24px;
            }

            .panel-1-list li{
                margin-right: 32px;
            }

            .panel-1-list li:first-child{
                font-size: 1.5em;
            }

            #sample-space-1 div:nth-child(even){
                background-color: white;
            }

            .panel-1-box{
                position: relative;
                opacity: 0;
                width: 80%;
                margin: auto;
                border-radius: 10px;
                box-shadow: -2px 2px 5px rgba(0,0,0,0.5);
                line-height: 2em;
                animation: 1s fade-in-side;
                animation-fill-mode: forwards !important;
            }

            #panel-3-list{
                opacity: 0;
                position: relative;
                top: 30px;
                list-style: none;
                animation: fade-in 1s;
                animation-fill-mode: forwards !important;
            }

            @keyframes fade-in{
                from{
                    opacity: 0;
                    top: 30px;
                }
                to{
                    opacity: 1;
                    top: 0px;
                }
            }

            #panel-3-list li{
                padding-bottom: 10px;
            }

            *[class*=progress-ring-svg]{
                position: relative;
                animation-fill-mode: forwards !important;
            }

            .progress-ring-svg-1{
                animation: "progress1" 1s;
            }

            .progress-ring-svg-2{
                animation: "progress2" 1s;
            }

            .progress-ring-svg-3{
                animation: "progress3" 1s;
            }

            /* Demo keyframes; use JS to generate them in future development */
            @keyframes progress1{
                from{
                    stroke-dashoffset: 0px;
                }

                to{
                    stroke-dashoffset: 200px;
                }
            }
            @keyframes progress2{
                from{
                    stroke-dashoffset: 0px;
                }

                to{
                    stroke-dashoffset: 300px;
                }
            }
            @keyframes progress3{
                from{
                    stroke-dashoffset: 0px;
                }

                to{
                    stroke-dashoffset: 100px;
                }
            }

            .svg-progress-bar{
                transition: .5s all;
            }

            .info-box{
                background-color: #eee;
                width: 80%;
                margin: auto;
                margin-top: 10px;
                border-radius: 13px;
                box-shadow: 0 2px 9px rgba(0,0,0,0.5);
                padding: 1px;
                position: relative;
                left: -30px;
                opacity: 0;
                animation-fill-mode: forwards !important;
            }

            .info-box-header{
                margin-top: 12px;
                margin-left: 10%;
            }


            @keyframes fade-in-side{
                from{
                    left: -30px;
                    opacity: 0;
                }
                to{
                    left: 0;
                    opacity: 1;
                }
            }

        </style>
    </head>

    <body>
        <div id=mapid></div>
        <div id=toggle-menu-wrapper>
            <div id=toggle-button onclick=toggle_sidebar()></div>
        </div>
        <div id=target-list-id></div>
        <div id=bottom-panel-wrapper>
            <div id=sample-space-1></div>
            <div id=sample-space-2></div>
            <div id=sample-space-3></div>
        </div>
        <script type="text/javascript">
            var lat = 44.036;
            var long = -71.621; // Loon Mountain, default location
    
            var mymap = L.map('mapid').setView([lat, long], 13); // Create map
            dataset = {}; // Spreadsheet data
            analysis = []; // Analysis spreadsheet data 
            svg_link = "http://www.w3.org/2000/svg"; // Namespace link

            function generate_li(elem, datum){
                // Return formatted list item
                return "<li><b>" + elem + "</b>: " + datum + "</li>";
            }

            function filter_targets(tr_class, lat, long, strike, jump=false){ 
            // Called when a tr is clicked in target-list or on marker hover
                clear_target_list();
                var class_list = document.getElementsByClassName(tr_class);
                var tr = class_list[1]; // 0 -> icon;  1 -> tr
                var img = class_list[0];
                img.classList.add("active_icon");
                img.src = "./green-marker.png";
                tr.className += " active";
                if(jump){ // Does the map need to move?
                    mymap.setView([lat, long]);
                }
                // Build bottom panel
                destroy_bottom_panel();
                generate_panels(strike, dataset[strike][0]["Entity Name"]);
            };

            function find_analysis_counts(strike){ 
                // From analysis spreadsheet get counts for each ATO in strike
                var to_return = [];
                analysis[0].forEach(function(d){
                    if (d['StrikeID'] == strike){
                        var conf = d['Confidence.count'];
                        var mea = d['MEA.count'];
                        var physical = d['Physical.count'];
                        to_return.push({'ATO': 'N/A', 'conf': conf, 'mea': mea, 'phys': physical});
                    }
                })
                return to_return;
            }

            function find_analysis_levels(strike){
                // From analysis spreadsheet get description for each ATO in strike
                var to_return = [];
                analysis[0].forEach(function(d){
                    if(d['StrikeID'] == strike){
                        var conf = d['Confidence.level'];
                        var mea = d['MEA.level'];
                        var physical = d['Physical.level'];
                        var cda = d['CDA.level'];
                        to_return.push({'ATO': 'N/A', 'MEA': mea, 'Physical': physical, 'CDA': cda, 'Confidence': conf});
                    }
                })
                return to_return
            }

            d3.csv("analysis.csv", function(d){ // Generate analysis variable
                analysis.push(d);
            });

            d3.csv("test.csv", function(d){ 
                // Load spreadsheet data and generate target list, markers, and global variables
                // Build popup includes
                var target_list = ["Strike #", "ATO", "Entity Name", "Country"];
                var target_list_title = document.createElement("h1");
                var target_list_table = document.createElement("table")
                var target_list_table_body = document.createElement("tbody");
                var target_list_tr = document.createElement("tr");
                var target_list_id_counter = 0;

                // Create target list table (unpopulated)
                target_list_title.innerText = "Click on a row to snap to a target";
                target_list_table.id = "target-list-table";
                target_list_table_body.id = "target-list-table-body";
                target_list_tr.id = "target-list-table-first"; 
                // Generate target list header
                target_list.forEach(function(elem){                
                    target_list_th = document.createElement("th");
                    target_list_th.innerText = elem;
                    target_list_tr.appendChild(target_list_th);
                });
                target_list_table_body.appendChild(target_list_tr);

                // For all rows in the spreadsheet...
                for(var index in d){
                    datum = d[index];
                    // Keep global dataset updated for global use
                    try{
                        dataset[datum["Strike #"]].push(datum);
                    }
                    catch(e){
                        dataset[datum["Strike #"]] = [datum];
                    }
                    d_lat  = datum["Lat"];
                    d_long = datum["Long"];
                    //d_marker = L.marker([d_lat, d_long], {icon: mushCloud}).addTo(mymap); // Place datum points
                    d_marker = L.marker([d_lat, d_long]).addTo(mymap); // Place datum points
                    d_marker_icon = d_marker._icon;
                    d_marker_icon.className += " " + String(target_list_id_counter);

                    // TARGET LIST
                    var target_list_tr = document.createElement("tr");
                    onclick_string = "filter_targets("+target_list_id_counter+","+d_lat+","+d_long+","+datum['Strike #']
                    target_list_tr.setAttribute("onclick", onclick_string + ", true)");
                    d_marker_icon.setAttribute("onmouseover", onclick_string + ")");

                    target_list.forEach(function(elem){
                        target_list_td = document.createElement("td");
                        target_list_td.innerText = datum[elem];
                        target_list_tr.appendChild(target_list_td);
                    });
                    target_list_tr.className = target_list_id_counter;
                    target_list_table_body.appendChild(target_list_tr);
                    target_list_id_counter++;
                };
                target_list = document.getElementById("target-list-id");
                target_list.appendChild(target_list_title);
                target_list_table.appendChild(target_list_table_body);
                target_list.appendChild(target_list_table);
            });

            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
                maxZoom: 18,
                id: 'mapbox.satellite',
                accessToken: "pk.eyJ1Ijoiam9uYm9uZDUiLCJhIjoiY2o1eHN6aGk3MDlxOTMzb2VwYTJrMDFrZyJ9.KHDHGTi1u8WoFyR6FoPg2A"
            }).addTo(mymap);

            function toggle_sidebar(){
                menu = document.getElementById("target-list-id");
                button = document.getElementById("toggle-button");
                map = document.getElementById("mapid");
                bottom = document.getElementById('bottom-panel-wrapper');
                if(menu.style.width != "25%"){
                    menu.style.width = "25%";
                    button.style.left = "calc(75% - 50px)";
                    bottom.style.width = "75%";
                    return
                }
                menu.style.width = "0px";
                button.style.left = "calc(100% - 50px)";
                bottom.style.width = "100%";
            }

            function destroy_bottom_panel(){
                bottom = document.getElementById("bottom-panel-wrapper");
                children = bottom.children;
                children = Array.from(children);
                children.forEach(function(elem){
                    elem.innerHTML = "";
                })
            }

            function clear_target_list(){
                var active_target = document.getElementsByClassName("active");
                var active_icon = document.getElementsByClassName("active_icon");
                if(active_target.length){
                    active_target[0].classList.remove("active");
                    active_icon[0].src = "./leaflet/images/marker-icon-2x.png";
                    active_icon[0].classList.remove("active_icon");
                }
            }

            function generate_progress_ring(class_name){
// https://codepen.io/xgad/post/svg-radial-progress-meters
                //bottom = document.getElementById('bottom-panel-wrapper');
                svg = document.createElementNS(svg_link,'svg');
                svg.setAttribute("class", "svg");
                svg.setAttribute("width", "150");
                svg.setAttribute("height", "150");
                back_ring = document.createElementNS(svg_link, 'circle');
                back_ring.setAttribute("cx", "60");
                back_ring.setAttribute("cy", "60");
                back_ring.setAttribute("r", "54");
                back_ring.setAttribute("fill", "none");
                back_ring.setAttribute("stroke-width", "12");
                front_ring = back_ring.cloneNode();
                back_ring.setAttribute("stroke", "#e6e6e6");
                front_ring.setAttribute("stroke-dasharray", "339.292");
                front_ring.setAttribute("transform", "rotate(-90 60 60)");
                front_ring.setAttribute("class", "progress-ring-svg-" + class_name);

                svg.appendChild(back_ring);
                svg.appendChild(front_ring);
                return svg;
            }

            function generate_progress_bar(x, y, width, text){
                rect = document.createElementNS(svg_link, 'rect');
                label = document.createElement("label");
                text_node = document.createTextNode(text);
                label.appendChild(text_node);
                rect.setAttribute("class", "svg-progress-bar");
                rect.setAttribute('x', x);
                rect.setAttribute('y', y);
                rect.setAttribute('width', 0);
                rect.setAttribute('width', width);
                rect.setAttribute('height', 35);
                return rect;
            }

            function generate_svg_bubble(text, cx, cy, r){
                svg = document.createElement("main-svg");
                circle = document.createElementNS(svg_link, 'circle');
                svg_text = document.createElementNS(svg_link, "text");
                text_node = document.createTextNode(text);
                circle.setAttribute("cx", cx);
                circle.setAttribute("cy", cy);
                circle.setAttribute("r", r);
                circle.setAttribute("fill", "white");
                svg_text.setAttribute("y", cy);
                svg_text.setAttribute("x", cx);
                svg_text.setAttribute("text-anchor", "middle");
                svg_text.appendChild(text_node);
                svg.appendChild(circle);
                svg.appendChild(svg_text);
            }

            function generate_panel_1(strike, entity_name){
                var panel = document.getElementById("sample-space-1");
                var header = document.createElement("h1");
                header.innerHTML = "<span style=color:green>" + entity_name + "</span> - levels";
                header.id = "panel-1-header";
                panel.appendChild(header);
                base_info_box = generate_info_boxes();
                base_info_box.className = "panel-1-box";
                var elements = find_analysis_levels(strike);
                elements.forEach(function(bda){
                    var box_clone = base_info_box.cloneNode();
                    var box_clone_header = document.createElement("h2");
                    var box_list = document.createElement("ol");
                    box_list.className = "panel-1-list";
                    for(var i in bda){
                        var box_list_item = document.createElement("li");
                        box_list_item.innerHTML = "<b>" + i + "</b>: " + bda[i];
                        box_list.appendChild(box_list_item);
                    }
                    box_clone.appendChild(box_list);
                    panel.appendChild(box_clone);
                });
                for(var i =1; i < panel.childElementCount; i++){
                    panel.childNodes[i].style.animationDelay = String(i / 4 - .25) + "s";
                }
            }

            function generate_panel_2(strike){
                var panel = document.getElementById("sample-space-2");
                var header = document.createElement("h1");
                header.innerText = "Effectiveness";

                // 1 to 1 ordinance to target check

            }

            function generate_panel_3(strike){
                var panel = document.getElementById("sample-space-3");
                var header = document.createElement("h1");
                header.innerText = "Target information";
                panel.appendChild(header);
                var info_list = document.createElement("ul");
                info_list.id = "panel-3-list";
                var data = dataset[strike][0];
                delete data[ Object.keys(data)[0] ]; // Remove row number
                for(var i in data){
                    info_list_elem = document.createElement("li");
                    info_list_elem.innerHTML = "<b>" + i + "</b>: " + data[i];
                    info_list.appendChild(info_list_elem);
                }
                panel.appendChild(info_list);
            }

            function generate_panels(strike, entity_name){
                generate_panel_1(strike, entity_name);
                generate_panel_2(strike);
                generate_panel_3(strike);
            }

            function generate_info_boxes(){
                var base_info_box = document.createElement("div");
                var base_info_box_header = base_info_box.cloneNode();
                var base_info_box_content = base_info_box.cloneNode();
                base_info_box.className = "info-box";
                base_info_box_header.className = "info-box-header";
                base_info_box_content.className = "info-box-content";
                base_info_box.appendChild(base_info_box_header);
                base_info_box.appendChild(base_info_box_content);
                return base_info_box;
            }

            /*

                var demo_ring_1 = generate_progress_ring("1");
                var demo_ring_2 = generate_progress_ring("2");
                var demo_ring_3 = generate_progress_ring("3");
                
                demo_ring_1.setAttribute("stroke", "#0ff");
                demo_ring_2.setAttribute("stroke", "#800");
                demo_ring_3.setAttribute("stroke", "#0f4");

                demo_ring_text_1 = document.createElementNS(svg_link, "text");
                demo_ring_text_2 = document.createElementNS(svg_link, "text");
                demo_ring_text_3 = document.createElementNS(svg_link, "text");
                demo_ring_text_1.innerHTML = "Confidence";
                demo_ring_text_2.innerHTML = "MEA";
                demo_ring_text_3.innerHTML = "Physical";
                var temp = [demo_ring_text_1, demo_ring_text_2, demo_ring_text_3];
                demo_ring_text_1.setAttribute("x", "20");
                demo_ring_text_2.setAttribute("x", "45");
                demo_ring_text_3.setAttribute("x", "30");
                temp.forEach(function(d){
                    d.setAttribute("y", "50");
                })

                demo_ring_1.appendChild(demo_ring_text_1);
                demo_ring_2.appendChild(demo_ring_text_2);
                demo_ring_3.appendChild(demo_ring_text_3);

                panel.appendChild(header);
                panel.appendChild(demo_ring_1);
                panel.appendChild(demo_ring_2);
                panel.appendChild(demo_ring_3);
                */
        </script>
    </body>
</html>